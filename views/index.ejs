<!DOCTYPE HTML>
<html>

<head>
    
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>

    <link rel="stylesheet" href="/styles/index.css" />
    <link rel="stylesheet" href="/bootstrap/css/mdb.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="/scripts/index.js"></script>

    <script src="/bootstrap/js/mdb.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script async defer crossorigin="anonymous"
        src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v19.0&appId=417605231226749"
        nonce="rsxWh6CJ"></script>
    <meta name="google-signin-client_id"
        content="142386812768-5dfql3hsf32etn4tpdpa7lo9dol09j4q.apps.googleusercontent.com">



</head>

<body>


    <!-- Nav bar -->
    <div class="nav-bar py-1 bg-white border-bottom">
        <div class="container d-flex justify-content-center align-items-center text-center">

            <!-- Left elements -->
            <div class="col">
                <% if (session && session.email) { %>
                    <!-- sign out button -->
                    <form id="signoutForm" action="/signout" method="POST">
                        <button type="submit" id="signoutBtn" class="border rounded nav-link d-inline-block">
                            <p class="btn mb-0">Sign out</p>
                        </button>
                    </form>

                    <% } else { %>
                        <!-- sign up and sign in buttons -->
                        <a href="/createAccount" class="border rounded nav-link d-inline-block">
                            <p class="btn d-md-block mb-0">Sign up</p>
                        </a>
                        <a href="/login" class="border rounded nav-link d-inline-block">
                            <p class="btn d-md-block mb-0">Sign in</p>
                        </a>
                        <% } %>
            </div>


            <!-- Centered title -->
            <div class="col" id="page_title" style="cursor: pointer;">
                <h1>Ruthy Michaels</h1>
            </div>


            <!-- Right elements -->
            <div class="col text-end">

                <a href="/account" class="m-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" class="bi bi-person-circle menu-item"
                        viewBox="0 0 16 16 ">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                        <path fill-rule="evenodd"
                            d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
                    </svg>
                </a>

                <a href="/wishlist" class="m-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" class="bi bi-heart-fill menu-item"
                        viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
                    </svg>
                </a>


                <a href="/basket" class="m-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" class="bi bi-cart4 menu-item"
                        viewBox="0 0 16 16">
                        <path
                            d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0" />
                    </svg>

                </a>


            </div>

        </div>

    </div>
    <!-- END nav bar -->


    <% if (session && (session.login || session.createAccount)) { %>
        <div id="overlay"></div>
        <% } %>

            <% if (session && session.login) { %>
                <div class="col-lg form-container border rounded justify-content-center align-items-center text-center">
                    <h2 class="text-center mt-2 mb-3">login</h2>

                    <!-- login form -->
                    <form id="login-form" class="container" style="width: 90%;" action="/login" method="POST">

                        <!-- Email input -->
                        <div class="form-outline mb-4" style="text-align: left;">
                            <input type="email" class="form-control border" id="email_login" name="email" required />
                            <label class="form-label" for="email_login">Email address</label>
                            <label class='error-label' for='email_login' id='emailError_login' hidden>* email
                                invalid</label>
                        </div>

                        <!-- Password input -->
                        <div class="form-outline mb-4" style="text-align: left;">
                            <input type="password" class="form-control border" id="password_login" name="password"
                                required />
                            <label class="form-label" for="password_login">Password</label>
                            <label class='error-label' for='password_login' id='passwordError_login' hidden>* password
                                must be 6 characters with 1 uppercase</label>
                        </div>

                        <!-- show password checkbox -->
                        <div class="row mb-4">
                            <div class="col d-flex justify-content-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" onclick="togglePassword()" /> show
                                    password
                                </div>
                            </div>
                        </div>

                        <!-- Submit button -->
                        <button type="SUBMIT" class="btn btn-primary btn-block mb-4">Sign in</button>

                        <p>or continue with</p>

                        <!-- Or Login with Facebook and Google buttons -->
                        <div class="login-buttons-container m-3">

                            <!-- FB login button -->
                            <div class="fa fa-facebook m-2" id="FBlogin"></div>

                            <!-- Google login button -->
                            <div class="g-signin2 m-2" data-width="50" data-height="50" data-longtitle="false" onlogin="onSignIn()"></div>

                            <div id="status"></div>

                        </div>

                        <!-- Log in button -->
                        <div class="text-center">
                            <p>Don't have an account? <a href="/createAccount">Sign up</a></p>
                        </div>

                    </form>

                </div>
                <% } %>

                    <% if (session && session.createAccount) { %>
                        <div
                            class="col-lg form-container border rounded justify-content-center align-items-center text-center">
                            <h2 class="text-center mt-2 mb-3">Create account</h2>

                            <!-- login form -->
                            <form id="createAccount-form" class="container" style="width: 90%;" action="/createAccount"
                                method="POST">

                                <!-- Email input -->
                                <div class="form-outline mb-4">
                                    <input type="email" class="form-control border" id="email_signup" name="email"
                                        required />
                                    <label class="form-label" for="email_signup">Email address</label>
                                    <label class='error-label' for='email_signup' id='emailError_signup' hidden>* email
                                        invalid</label>
                                </div>

                                <!-- Password input -->
                                <div class="form-outline mb-4">
                                    <input type="password" class="form-control border" id="password_signup"
                                        name="password" required />
                                    <label class="form-label" for="password_signup">Password</label>
                                    <label class='error-label' for='password_signup' id='passwordError_signup' hidden>*
                                        password must
                                        be 6
                                        characters with 1 uppercase</label>
                                </div>

                                <!-- Confirm password input -->
                                <div class="form-outline mb-4">
                                    <input type="password" class="form-control border" id="confPassword_signup"
                                        name="confPassword" required />
                                    <label class="form-label" for="confPassword_signup">Confirm password</label>
                                    <label class='error-label' for='confPassword_signup' id='confPasswordError_signup'
                                        hidden>*
                                        passwords must
                                        match</label>
                                </div>

                                <!-- show password checkbox -->
                                <div class="row mb-4">
                                    <div class="col d-flex justify-content-center">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                onclick="togglePassword()" /> show password
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit button -->
                                <button type="SUBMIT" class="btn btn-primary btn-block mb-4">Sign up</button>

                                <p>or continue with</p>

                                <!-- Or Login with Facebook and Google buttons -->
                                <div class="login-buttons-container m-3">
        
                                    <!-- FB login button -->
                                    <div class="fa fa-facebook m-2" id="FBlogin"></div>
        
                                    <!-- Google login button -->
                                    <div class="g-signin2 m-2" data-width="50" data-height="50" data-longtitle="false" onlogin="onSignIn()"></div>
        
                                    <div id="status"></div>
        
                                </div>

                                <!-- Log in button -->
                                <div class="text-center">
                                    <p>Already have an account? <a href="/login">Sign in</a></p>
                                </div>
                            </form>

                        </div>
                        <% } %>

</body>


<footer>

    <script>

        var user_email = `<% session.email %>` || null;

        function onSignIn(googleUser) {
            var profile = googleUser.getBasicProfile();
            console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
            console.log('Name: ' + profile.getName());
            console.log('Image URL: ' + profile.getImageUrl());
            console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
        }

        window.fbAsyncInit = function () {
            FB.init({
                appId: '417605231226749',
                cookie: true,
                xfbml: true,
                version: 'v19.0'
            });
            FB.AppEvents.logPageView();
            checkLoginState();
        };

        function checkLoginState() {
            FB.getLoginStatus(function (response) {
                if (response.status === 'connected') {
                    statusChangeCallback(response);
                };
            });
        };

        // facebook login
        function statusChangeCallback(response) {
            if (response.status === 'connected') {
                // Logged into your app and Facebook.
                testAPI();
            } else {
                document.getElementById('status').innerHTML = 'Please log into this app.';
                window.location.href = '/login';
            }
        };

        function testAPI() {
            console.log('testAPI called');
            FB.getLoginStatus(function (response) {
                if (response.status === 'connected' && !(user_email === null)) {
                    FB.api('/me', { access_token: response.authResponse.accessToken, fields: 'name,email' }, function (response) {
                        if (response.name && response.email) {
                            console.log('succesfull login for ' + response.email)
                            document.cookie = `sessionID=${response.id}; path=/; secure; samesite=Strict`;
                            document.cookie = `sessionEmail=${response.email}; path=/; secure; samesite=Strict`;
                            // window.location.href = '/home';

                        };
                    });
                };
            });
        };

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // handle Facebook logout and then server-side logout
        if (document.getElementById('signoutBtn')) {
            document.getElementById('signoutBtn').addEventListener('click', function () {
                FB.logout(function (response) {
                    // Log out from the server side after Facebook logout
                    document.getElementById('signoutForm').submit();
                });
            });
        };

        // Custom Facebook login function
        function customFacebookLogin() {
            FB.login(function (response) {
                if (response.authResponse) {
                    checkLoginState();
                }
            }, { scope: 'public_profile,email' });
        }

        // Add event listener to the custom element
        document.getElementById('FBlogin').addEventListener('click', function () {
            customFacebookLogin();
        })

    </script>

</footer>

</html>